!function(e){var r={};function t(n){if(r[n])return r[n].exports;var s=r[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:n})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(t.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var s in e)t.d(n,s,function(r){return e[r]}.bind(null,s));return n},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s="./server/server.ts")}({"./server/classes/character.ts":
/*!*************************************!*\
  !*** ./server/classes/character.ts ***!
  \*************************************/
/*! no static exports found */function(module,exports,__webpack_require__){"use strict";eval('\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, "__esModule", { value: true });\r\nexports.CharacterChanged = exports.GetCharacter = exports.GetCharacters = void 0;\r\nconst sql_1 = __webpack_require__(/*! ../lib/sql */ "./server/lib/sql.ts");\r\nconst charactersId = new sql_1.Cache("characters", "id");\r\nconst charactersDiscord = new sql_1.ArrayCache("characters", "player_discord");\r\nfunction GetCharacters(discord) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        return yield charactersDiscord.get(discord);\r\n    });\r\n}\r\nexports.GetCharacters = GetCharacters;\r\nfunction GetCharacter(characterID) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        return yield charactersId.get(characterID);\r\n    });\r\n}\r\nexports.GetCharacter = GetCharacter;\r\nfunction CharacterChanged(discord) {\r\n    charactersId.changed(charactersDiscord[discord].id);\r\n    charactersDiscord.changed(discord);\r\n}\r\nexports.CharacterChanged = CharacterChanged;\r\n\n\n//# sourceURL=webpack:///./server/classes/character.ts?')},"./server/classes/player.ts":
/*!**********************************!*\
  !*** ./server/classes/player.ts ***!
  \**********************************/
/*! no static exports found */function(module,exports,__webpack_require__){"use strict";eval('\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, "__esModule", { value: true });\r\nexports.PlayerChanged = exports.GetPlayer = exports.GetPlayerSrc = void 0;\r\nconst sql_1 = __webpack_require__(/*! ../lib/sql */ "./server/lib/sql.ts");\r\nconst identifiers_1 = __webpack_require__(/*! ../lib/identifiers */ "./server/lib/identifiers.ts");\r\nconst players = new sql_1.Cache("players", "discord");\r\nfunction GetPlayerSrc(src) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        const discord = identifiers_1.GetPlayerIdentifiers(src).discord;\r\n        if (discord.length > 0) {\r\n            return yield GetPlayer(discord);\r\n        }\r\n    });\r\n}\r\nexports.GetPlayerSrc = GetPlayerSrc;\r\nfunction GetPlayer(discord) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        return yield players.get(discord);\r\n    });\r\n}\r\nexports.GetPlayer = GetPlayer;\r\nfunction PlayerChanged(discord) {\r\n    players.changed(discord);\r\n}\r\nexports.PlayerChanged = PlayerChanged;\r\n\n\n//# sourceURL=webpack:///./server/classes/player.ts?')},"./server/lib/identifiers.ts":
/*!***********************************!*\
  !*** ./server/lib/identifiers.ts ***!
  \***********************************/
/*! no static exports found */function(module,exports,__webpack_require__){"use strict";eval('\r\nObject.defineProperty(exports, "__esModule", { value: true });\r\nexports.GetPlayerIdentifiers = void 0;\r\nfunction GetPlayerIdentifiers(src) {\r\n    let discord = "";\r\n    let steam = "";\r\n    for (let i = 0; i < GetNumPlayerIdentifiers(src); i++) {\r\n        const identifier = GetPlayerIdentifier(src, i);\r\n        if (identifier.startsWith(\'discord\')) {\r\n            discord = identifier;\r\n        }\r\n        if (identifier.startsWith(\'steam\')) {\r\n            steam = identifier;\r\n        }\r\n    }\r\n    return { discord: discord, steam: steam };\r\n}\r\nexports.GetPlayerIdentifiers = GetPlayerIdentifiers;\r\n\n\n//# sourceURL=webpack:///./server/lib/identifiers.ts?')},"./server/lib/sql.ts":
/*!***************************!*\
  !*** ./server/lib/sql.ts ***!
  \***************************/
/*! no static exports found */function(module,exports,__webpack_require__){"use strict";eval('\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, "__esModule", { value: true });\r\nexports.ArrayCache = exports.Cache = exports.scalarSync = exports.scalar = exports.executeSync = exports.execute = void 0;\r\nconst timeout = 500;\r\nfunction execute(query, parameters, callback) {\r\n    global.exports.ghmattimysql.execute(query, parameters, callback);\r\n}\r\nexports.execute = execute;\r\nfunction executeSync(query, parameters) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        return PromiseTimeout(new Promise((resolve) => {\r\n            global.exports.ghmattimysql.execute(query, parameters, (result) => { resolve(result); });\r\n        }), timeout);\r\n    });\r\n}\r\nexports.executeSync = executeSync;\r\nfunction scalar(query, parameters, callback) {\r\n    global.exports.ghmattimysql.scalar(query, parameters, callback);\r\n}\r\nexports.scalar = scalar;\r\nfunction scalarSync(query, parameters) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        return PromiseTimeout(new Promise((resolve) => {\r\n            global.exports.ghmattimysql.scalar(query, parameters, (result) => { resolve(result); });\r\n        }), timeout);\r\n    });\r\n}\r\nexports.scalarSync = scalarSync;\r\nfunction PromiseTimeout(promise, ms) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        return Promise.race([\r\n            new Promise((_resolve, reject) => { const wait = setTimeout(() => { clearTimeout(wait); reject("timeout"); }, ms); }),\r\n            promise\r\n        ]);\r\n    });\r\n}\r\nfunction isEmpty(obj) {\r\n    return Object.keys(obj).length === 0;\r\n}\r\n// How to use:\r\n// \tconst yourCache = new Cache<yourInterface>("table", "keyColumn"); <-- yourInterface is an interface that matches the columns of the database\r\n// \tconst row = await yourCache.get(value);  <-- put this in an async function\r\n// \tyou can also do: yourCache.get(value).then(...)\r\n//\r\n// If a row is changed:\r\n//\tYou need to clear out the row in the cache so we get it from the database again\r\n//\tyourCache.changed(key)\r\nclass Cache {\r\n    constructor(table, keyColumn) {\r\n        this.cache = {};\r\n        this.multipleCache = {};\r\n        this.query = `SELECT * FROM ${table} WHERE ${keyColumn} = ?`;\r\n    }\r\n    get(key) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.cache[key]) {\r\n                const value = yield executeSync(this.query, [key]);\r\n                if (!isEmpty(value) && !Array.isArray(value)) {\r\n                    this.cache[key] = value;\r\n                }\r\n                else if (Array.isArray(value)) {\r\n                    this.cache[key] = value[0];\r\n                }\r\n            }\r\n            return this.cache[key];\r\n        });\r\n    }\r\n    getMultiple(key) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.cache[key]) {\r\n                const value = yield executeSync(this.query, [key]);\r\n                if (Array.isArray(value)) {\r\n                    this.multipleCache[key] = value;\r\n                }\r\n            }\r\n            return this.multipleCache[key];\r\n        });\r\n    }\r\n    changed(key) {\r\n        this.cache[key] = null;\r\n    }\r\n}\r\nexports.Cache = Cache;\r\nclass ArrayCache {\r\n    constructor(table, keyColumn) {\r\n        this.cache = {};\r\n        this.query = `SELECT * FROM ${table} WHERE ${keyColumn} = ?`;\r\n    }\r\n    get(key) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (!this.cache[key]) {\r\n                const value = yield executeSync(this.query, [key]);\r\n                if (!isEmpty(value)) {\r\n                    this.cache[key] = value;\r\n                }\r\n            }\r\n            return this.cache[key];\r\n        });\r\n    }\r\n    changed(key) {\r\n        this.cache[key] = null;\r\n    }\r\n}\r\nexports.ArrayCache = ArrayCache;\r\n\n\n//# sourceURL=webpack:///./server/lib/sql.ts?')},"./server/server.ts":
/*!**************************!*\
  !*** ./server/server.ts ***!
  \**************************/
/*! no static exports found */function(module,exports,__webpack_require__){"use strict";eval('\r\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}));\r\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, "default", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o["default"] = v;\r\n});\r\nvar __importStar = (this && this.__importStar) || function (mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== "default" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n};\r\nObject.defineProperty(exports, "__esModule", { value: true });\r\nconst identifiers_1 = __webpack_require__(/*! ./lib/identifiers */ "./server/lib/identifiers.ts");\r\nconst players = __importStar(__webpack_require__(/*! ./classes/player */ "./server/classes/player.ts"));\r\nconst characters = __importStar(__webpack_require__(/*! ./classes/character */ "./server/classes/character.ts"));\r\nconst sql = __importStar(__webpack_require__(/*! ./lib/sql */ "./server/lib/sql.ts"));\r\nonNet(\'ft-core:tpm\', () => {\r\n    console.log(`TPM by ${source}`);\r\n});\r\nonNet(\'playerConnecting\', () => {\r\n    insertOrUpdatePlayer(source);\r\n});\r\nfunction insertOrUpdatePlayer(src) {\r\n    const identifiers = identifiers_1.GetPlayerIdentifiers(src);\r\n    sql.execute("INSERT INTO `players` (`steam`,`discord`) VALUES (?, ?) ON DUPLICATE KEY UPDATE `steam` = ?", [identifiers.steam, identifiers.discord, identifiers.steam], () => {\r\n        players.PlayerChanged(identifiers.discord);\r\n    });\r\n}\r\nRegisterCommand(\'sql\', (src) => {\r\n    const identifiers = identifiers_1.GetPlayerIdentifiers(src);\r\n    sql.execute("INSERT INTO `players` (`steam`,`discord`) VALUES (?, ?) ON DUPLICATE KEY UPDATE `steam` = ?", [identifiers.steam, identifiers.discord, identifiers.steam], () => {\r\n        players.PlayerChanged(identifiers.discord);\r\n    });\r\n}, false);\r\nRegisterCommand(\'chars\', (src) => {\r\n    const discord = identifiers_1.GetPlayerIdentifiers(src).discord;\r\n    characters.GetCharacters(discord).then((chars) => { setImmediate(() => console.log(JSON.stringify(chars))); });\r\n}, false);\r\nRegisterCommand(\'char\', (_src, args) => {\r\n    characters.GetCharacter(args[0]).then((char) => { setImmediate(() => console.log(JSON.stringify(char))); });\r\n}, false);\r\n\n\n//# sourceURL=webpack:///./server/server.ts?')}});